{% extends 'base.html' %}
{% load static %}

{% block title %}Quick Add Agent - Firewall Central{% endblock %}

{% block extra_css %}
<style>
    .quick-add-card {
        max-width: 600px;
        margin: 2rem auto;
    }
    
    .field-group {
        margin-bottom: 1rem;
    }
    
    .form-help {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .connection-preview {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 1rem;
        border-radius: 0.375rem;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card quick-add-card">
                <div class="card-header text-center">
                    <h3><i class="fas fa-magic me-2"></i>Quick Add Agent</h3>
                    <p class="text-muted mb-0">Add an agent with automatic connection detection</p>
                </div>
                <div class="card-body">
                    <form method="post" id="quick-add-form">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <h6>Please correct the following errors:</h6>
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <div>{{ field }}: {{ error }}</div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="field-group">
                            <label for="{{ form.hostname.id_for_label }}" class="form-label">
                                <i class="fas fa-server me-1"></i>Hostname *
                            </label>
                            {{ form.hostname }}
                            <div class="form-help">The hostname or FQDN of the target server</div>
                        </div>

                        <div class="field-group">
                            <label for="{{ form.ip_address.id_for_label }}" class="form-label">
                                <i class="fas fa-network-wired me-1"></i>IP Address *
                            </label>
                            {{ form.ip_address }}
                            <div class="form-help">The IP address of the target server</div>
                        </div>

                        <div class="field-group">
                            <label for="{{ form.connection_type.id_for_label }}" class="form-label">
                                <i class="fas fa-link me-1"></i>Connection Type
                            </label>
                            {{ form.connection_type }}
                            <div class="form-help">Select 'Auto-detect' to automatically determine the best connection method</div>
                        </div>

                        <div id="ssh-username-group" class="field-group" style="display: none;">
                            <label for="{{ form.ssh_username.id_for_label }}" class="form-label">
                                <i class="fas fa-user me-1"></i>SSH Username
                            </label>
                            {{ form.ssh_username }}
                            <div class="form-help">Username for SSH connections (usually 'root')</div>
                        </div>

                        <div class="field-group">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                <i class="fas fa-comment me-1"></i>Description
                            </label>
                            {{ form.description }}
                            <div class="form-help">Optional description for this agent</div>
                        </div>

                        <div id="connection-preview" class="connection-preview" style="display: none;">
                            <h6><i class="fas fa-info-circle me-2"></i>Connection Preview</h6>
                            <div id="preview-content"></div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <div>
                                <a href="{% url 'agent-list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-1"></i>Back to Agents
                                </a>
                                <a href="{% url 'agent-create' %}" class="btn btn-outline-primary ms-2">
                                    <i class="fas fa-cogs me-1"></i>Advanced Setup
                                </a>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i>Add Agent
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Cards -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-magic fa-2x text-primary mb-3"></i>
                            <h6>Auto-Detection</h6>
                            <p class="small text-muted">
                                Automatically determines the best connection method based on the target system.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-terminal fa-2x text-success mb-3"></i>
                            <h6>SSH Connection</h6>
                            <p class="small text-muted">
                                Uses standard SSH to connect and manage firewalld directly or through an agent.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-cogs fa-2x text-warning mb-3"></i>
                            <h6>Advanced Setup</h6>
                            <p class="small text-muted">
                                Configure all connection options manually for complex environments.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const connectionTypeSelect = document.getElementById('id_connection_type');
    const sshUsernameGroup = document.getElementById('ssh-username-group');
    const connectionPreview = document.getElementById('connection-preview');
    const previewContent = document.getElementById('preview-content');
    const hostnameField = document.getElementById('id_hostname');
    const ipAddressField = document.getElementById('id_ip_address');

    function updateForm() {
        const connectionType = connectionTypeSelect.value;
        
        // Show/hide SSH username field
        if (connectionType === 'ssh' || connectionType === 'auto') {
            sshUsernameGroup.style.display = 'block';
        } else {
            sshUsernameGroup.style.display = 'none';
        }
        
        updatePreview();
    }

    function updatePreview() {
        const connectionType = connectionTypeSelect.value;
        const hostname = hostnameField.value;
        const ipAddress = ipAddressField.value;
        
        if (!hostname && !ipAddress) {
            connectionPreview.style.display = 'none';
            return;
        }
        
        connectionPreview.style.display = 'block';
        
        let previewHtml = '';
        switch(connectionType) {
            case 'auto':
                previewHtml = `
                    <div class="small">
                        <strong>Auto-detection will:</strong>
                        <ul class="mb-0 mt-1">
                            <li>Test SSH connectivity on port 22</li>
                            <li>Check for existing agent on port 8444</li>
                            <li>Fall back to agent-to-server mode</li>
                        </ul>
                    </div>
                `;
                break;
            case 'ssh':
                previewHtml = `
                    <div class="small">
                        <strong>SSH Connection:</strong><br>
                        Will connect to <code>${ipAddress || hostname}:22</code> using SSH
                    </div>
                `;
                break;
            case 'agent_to_server':
                previewHtml = `
                    <div class="small">
                        <strong>Agent-to-Server:</strong><br>
                        Agent on <code>${hostname || ipAddress}</code> will connect to this server
                    </div>
                `;
                break;
            case 'server_to_agent':
                previewHtml = `
                    <div class="small">
                        <strong>Server-to-Agent:</strong><br>
                        Server will connect to agent at <code>${ipAddress || hostname}:8444</code>
                    </div>
                `;
                break;
        }
        
        previewContent.innerHTML = previewHtml;
    }

    // Initialize
    updateForm();
    
    // Event listeners
    connectionTypeSelect.addEventListener('change', updateForm);
    hostnameField.addEventListener('input', updatePreview);
    ipAddressField.addEventListener('input', updatePreview);
});
</script>
{% endblock %}